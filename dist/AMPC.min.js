// ==UserScript==
// @name        AnimeMerchPriceConverter
// @namespace   http://mrkannah.com
// @updateURL   https://raw.githubusercontent.com/fadeenk/Anime-merch-price-converter/master/dist/AMPC.min.js
// @description Converts prices from jpy to usd
// @include     http://slist.amiami.com/top/search/*
// @include     http://www.amiami.com/*
// @include     http://order.mandarake.co.jp/*
// @grant       GM_setValue
// @grant       GM_getValue
// @version     0.5.0
// @require     http://code.jquery.com/jquery-2.1.3.min.js
// ==/UserScript==

/*
Copyright (C) 2015  Fadee Kannah

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
*/

function injectJs(a){var b=document.createElement("script");b.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(b)}function getRate(a,b){var c=document.createElement("script");c.setAttribute("src",'http://query.yahooapis.com/v1/public/yql?q=select%20rate%2Cname%20from%20csv%20where%20url%3D"http%3A%2F%2Fdownload.finance.yahoo.com%2Fd%2Fquotes%3Fs%3D'+a+b+'%253DX%26f%3Dl1n"%20and%20columns%3D"rate%2Cname"&format=json&callback=parseExchangeRate'),document.body.appendChild(c),localStorage.setItem(currentUnit+".date",now)}function parseExchangeRate(a){var b=parseFloat(a.query.results.row.rate,10),c=a.query.results.row.name.split("/")[1];localStorage.setItem(c+".rate",b),applyConversions(c)}function applyConversions(a){jQuery.fn.justNumber=function(){return $(this).clone().children().remove().end().text().replace(/\D+/g,"")};var b={USD:{symbol:"$",name:"US Dollar"},EUR:{symbol:"â‚¬",name:"Euro"}};setUpSettings(a,b);for(var c=parseFloat(localStorage.getItem(a+".rate")),d=$("li.product_price, li.selling_price:first, li.price, div.basicinfo dl :nth-child(6) p, div.price > p"),e=0;e<d.length;e++){var f=$(d[e]).justNumber(),g=(f*c).toFixed(2);$(d[e]).append('<p class="convertedPrice">'+b[a].symbol+g+"</p>")}}function setUpSettings(a,b){var c="";for(var d in b)c+='<option value="'+d+'">'+b[d].name+" ("+d+")</option>";$("body").append('<div id="settingsPanel"><span style="float:right;margin-top: -10px;margin-right: -5px;">X</span><h1 style="text-align: center;font-size: 24px;font-weight: 500;">AMPC Settings</h1>Select your currency: <select class="UNITS">'+c+'</select><br><button id="update">Update</button></div></div>'),$(".UNITS").val(a),$("#settingsPanel").hide(),$("#update").click(function(){localStorage.setItem("currentUnit",$(".UNITS").val()),location.reload(!0)}),$("#settingsPanel span").click(function(){$("#settingsPanel").hide()})}this.$=this.jQuery=jQuery.noConflict(!0);var css=".convertedPrice{background-color: #57C553;border-radius: 7px;text-align: center;border: 4px solid #f4f4f4;box-shadow: 0 2px 2px rgba(0,0,0,.18);font-size: 20px;color: #fff;font-weight: 600;display: block;margin-left: auto !important;margin-right: auto !important;width:100px;}",style=document.createElement("style");style.appendChild(document.createTextNode(css)),document.getElementsByTagName("head")[0].appendChild(style);var currentUnit=localStorage.getItem("currentUnit")||"USD",conversionDate=GM_getValue(currentUnit+".date")||0,now=Date.now();GM_getValue(currentUnit+".rate")&&localStorage.getItem(currentUnit+".rate")?parseInt(localStorage.getItem(currentUnit+".date"))<conversionDate?(localStorage.setItem(currentUnit+".rate",GM_getValue(currentUnit+".rate")),localStorage.setItem(currentUnit+".date",conversionDate)):parseInt(localStorage.getItem(currentUnit+".date"))>conversionDate&&(GM_setValue(currentUnit+".rate",localStorage.getItem(currentUnit+".rate")),GM_setValue(currentUnit+".date",localStorage.getItem(currentUnit+".date"))):GM_getValue(currentUnit+".rate")?(localStorage.setItem(currentUnit+".rate",GM_getValue(currentUnit+".rate")),localStorage.setItem(currentUnit+".date",conversionDate)):localStorage.getItem(currentUnit+".rate")&&GM_setValue(currentUnit+".rate",localStorage.getItem(currentUnit+".rate")),now-conversionDate>864e5?(injectJs(parseExchangeRate),getRate("JPY",currentUnit)):applyConversions(currentUnit),injectJs(applyConversions);var css=".settings{position: fixed;bottom: 10px;right: 10px;width: 40px;background: #57C553;border-radius: 50px;z-index: 100;};",style=document.createElement("style");style.appendChild(document.createTextNode(css)),document.getElementsByTagName("head")[0].appendChild(style);var css="#settingsPanel{z-index: 100;position: fixed;top: 100px;width: 80%;background: #57C553;border-radius: 10px;left: 50%;margin: 0 0 0 -40%;border: 6px solid #f4f4f4;box-shadow: 0 2px 2px rgba(0,0,0,.18);color:#FFF;padding:10px;text-align: center;};",style=document.createElement("style");style.appendChild(document.createTextNode(css)),document.getElementsByTagName("head")[0].appendChild(style);var img=document.createElement("img");img.setAttribute("src","http://png-5.findicons.com/files/icons/949/token/256/gear.png"),img.setAttribute("class","settings"),img.setAttribute("id","AMPCsettings"),$("body").append(img),$("#AMPCsettings").click(function(){$("#settingsPanel").show()});